{{/*
  launchbutton shortcode

  Renders a button that POSTs application/x-www-form-urlencoded to a URL.
  Defaults to using a regular HTML form submission (reliable; no CORS required).
  Optional: fill useremail from cookie/query, or do AJAX if you control CORS.

  Params:
    - action (required): URL to POST to
    - lab / labdefinition (required): value for odlconfigname
    - customer (optional, default "1234")
    - smartticket (optional, default "5678")
    - useremail (optional): pass explicit email; otherwise can auto-fill
    - userop (optional, default "Create")
    - button (optional, default "Launch Demo")
    - class (optional): classes for the button element
    - target (optional, default "_blank"): where to submit result
    - useremailFrom (optional): "cookie:fortiuser" or "query:fortiuser"
    - ajax (optional): "true" to use fetch() instead of form submission
*/}}
{{ $action := .Get "action" }}
{{ $lab := or (.Get "lab") (.Get "labdefinition") }}
{{ $customer := (.Get "customer") | default "1234" }}
{{ $smartticket := (.Get "smartticket") | default "5678" }}
{{ $useremail := .Get "useremail" }}
{{ $userop := (.Get "userop") | default "Create" }}
{{ $button := (.Get "button") | default "Launch Demo" }}
{{ $class := .Get "class" }}
{{ $target := (.Get "target") | default "_blank" }}
{{ $useremailFrom := .Get "useremailFrom" }}
{{ $ajax := (eq (.Get "ajax") "true") }}

{{ if not $action }}
  <div class="notice error">launchbutton: missing required param 'action'</div>
{{ else if not $lab }}
  <div class="notice error">launchbutton: missing required param 'lab' (or 'labdefinition')</div>
{{ else }}
  {{ $fid := printf "launchbtn-%d" now.Unix }}
  <form id="{{ $fid }}" method="post" action="{{ $action }}" target="{{ $target }}" {{ if $ajax }}data-ajax="true"{{ end }}>
    <input type="hidden" name="customer" value="{{ $customer }}">
    <input type="hidden" name="smartticket" value="{{ $smartticket }}">
    <input type="hidden" name="useremail" value="{{ $useremail }}">
    <input type="hidden" name="userop" value="{{ $userop }}">
    <input type="hidden" name="odlconfigname" value="{{ $lab }}">
    <button type="submit" {{ with $class }}class="{{ . }}"{{ end }}>{{ $button }}</button>
  </form>

  <script>
    (function() {
      var form = document.getElementById({{ printf "%q" $fid }});
      if (!form) return;

      // Fill useremail from cookie or query if requested and not supplied
      var useremailInput = form.querySelector('input[name="useremail"]');
      if (useremailInput && (!useremailInput.value || useremailInput.value === '')) {
        var source = {{ printf "%q" $useremailFrom }};
        function getCookie(name) {
          var m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
          return m ? decodeURIComponent(m[1]) : '';
        }
        function getQuery(name) {
          var u = new URL(window.location.href);
          return u.searchParams.get(name) || '';
        }
        if (source === 'cookie:fortiuser') {
          useremailInput.value = getCookie('fortiuser');
        } else if (source === 'query:fortiuser') {
          useremailInput.value = getQuery('fortiuser');
        }
      }

      // AJAX mode (requires CORS on the target). Falls back to normal submit on error.
      if (form.hasAttribute('data-ajax')) {
        form.addEventListener('submit', function(ev) {
          ev.preventDefault();
          try {
            var params = new URLSearchParams(new FormData(form));
            fetch(form.action, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: params.toString(),
              mode: 'cors',
              credentials: 'omit'
            }).then(function(res) {
              if (!res.ok) throw new Error('HTTP ' + res.status);
              return res.text();
            }).then(function(txt) {
              alert('Request submitted successfully.');
              console.log('Response:', txt);
            }).catch(function(err) {
              console.warn('AJAX post failed, falling back to regular submit:', err);
              form.removeAttribute('data-ajax');
              form.submit();
            });
          } catch (e) {
            console.warn('AJAX setup error, falling back to regular submit:', e);
            form.removeAttribute('data-ajax');
            form.submit();
          }
        });
      }
    })();
  </script>
{{ end }}

