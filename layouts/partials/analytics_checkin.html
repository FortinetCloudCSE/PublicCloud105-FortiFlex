{{- $marketingCode := .Site.Params.marketingCode | default " " }}

<div id="display-form"></div>
<script>

// todo:  handle refreshing page, bypasses checkin

const container = document.getElementById('display-form');

function setCookie(name, value, days, domainOverride) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  const expires = 'expires=' + d.toUTCString();
  // Heuristic: try to set cookie for the registrable domain (e.g., example.com).
  // Falls back to current host if browser rejects the wider domain.
  const host = location.hostname;
  const parts = host.split('.');
  const baseDomain = parts.length > 2 ? parts.slice(-2).join('.') : host;
  const domain = domainOverride || baseDomain;
  let cookie = `${name}=${encodeURIComponent(value)};${expires};path=/;`;
  // If attempting cross-site usage between subdomains, you may want SameSite=None;Secure
  // but keep it Lax by default for fewer restrictions.
  cookie += 'SameSite=Lax;';
  if (location.protocol === 'https:') cookie += 'Secure;';
  // Try setting with the wider domain first
  document.cookie = cookie + `Domain=.${domain};`;
  // Also set a host-only cookie as a fallback
  document.cookie = cookie;
}

function getCookie(cname) {
  const name = cname + '=';
  const ca = decodeURIComponent(document.cookie).split(';');
  for (let c of ca) {
    while (c.charAt(0) === ' ') c = c.substring(1);
    if (c.indexOf(name) === 0) return c.substring(name.length, c.length);
  }
  return '';
}

function removeCookie(name) {
  // Expire both host-only and domain cookie variants
  const past = 'expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;';
  const host = location.hostname;
  const parts = host.split('.');
  const baseDomain = parts.length > 2 ? parts.slice(-2).join('.') : host;
  document.cookie = `${name}=;${past}`;
  document.cookie = `${name}=;${past}Domain=.${baseDomain};`;
}

function saveProfileToStorage(profile) {
  try { localStorage.setItem('forti_profile', JSON.stringify(profile)); } catch(e) {}
}

function loadProfileFromStorage() {
  try {
    const raw = localStorage.getItem('forti_profile');
    return raw ? JSON.parse(raw) : null;
  } catch(e) { return null; }
}

function prefillAnyMatchingInputs(profile) {
  if (!profile) return;
  const map = {
    email: ['email','Email','EMail'],
    customer: ['customer','Customer'],
    event: ['event','Event']
  };
  Object.entries(map).forEach(([k, names]) => {
    names.forEach(n => {
      const elById = document.getElementById(n);
      if (elById && !elById.value) elById.value = profile[k] || '';
      const elByName = document.querySelector(`[name="${n}"]`);
      if (elByName && !elByName.value) elByName.value = profile[k] || '';
    });
  });
}


let user = getCookie("fortiuser");
if (user == "") {

// action
//http://localhost:8080/reg/cookie.html
// container.innerHTML = '<form id="provision-lab" action="http://localhost:8080/reg/cookie.html">' +
//https://tecanalytics.forticloudcse.com/checkin
container.innerHTML = '<form id="provision-lab" action="https://tecanalytics.forticloudcse.com/checkin" method="post">' +
  '<b><font size="7">Welcome!</font></b><br>' +
  '<b><font color="red">Please check-in for this workshop to proceed (REQUIRED)</font></b>' +
 '<label for="email">Please enter your email address</label>' +
 '<input type="email" required id="email" name="EMail" value="" />' +
 '<label for="customer">Please enter an associated customer name (if any)</label>' +
 '<input type="text" id="customer" name="Customer" value="" />' +
 '<label for="event">Please enter the Event Name/Code or Smart Ticket (if any)</label>' +
 '<input type="text" id="event" name="Event" value="{{ $marketingCode }}" />' +
 '<input type="submit" value="Check-in" />' +
 '<input type="hidden" name="uid" id="uid" value="">' +
 '<input type="hidden" name="current_page" id="current_page" value="">' +
 '<input type="hidden" name="labdefinition" id="labdefinition" value="">' +
 '<hr>' +
 '</form>';

// Prefill from any existing profile prior to user typing
prefillAnyMatchingInputs(loadProfileFromStorage());

const form = document.getElementById('provision-lab');
form.addEventListener('submit', function() {
  const email = (document.getElementById('email') || {}).value || '';
  const customer = (document.getElementById('customer') || {}).value || '';
  const eventName = (document.getElementById('event') || {}).value || '';
  const profile = { email, customer, event: eventName };
  saveProfileToStorage(profile);
  setCookie('fortiemail', email, 5);
  setCookie('forticustomer', customer, 5);
  setCookie('fortievent', eventName, 5);
  // ensure uuid cookie exists for correlation
  let uuidCookie = getCookie('fortiuser');
  if (!uuidCookie) {
    const uuid = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
    setCookie('fortiuser', uuid, 5);
    const uidEl = document.getElementById('uid');
    if (uidEl) uidEl.value = uuid;
  }
});

} else {
  const profile = loadProfileFromStorage();
  const knownEmail = getCookie('fortiemail') || (profile && profile.email) || '';
  container.innerHTML = '<p><b><font size="7">Welcome!</font></b></p>' +
    '<p><b>Thank you for checking into this session! Your session will persist for 5 days across the Fortinet CSE Workshop estate. You may now proceed with the workshop!!!</b></p>' +
    (knownEmail ? ('<p><i>Signed in as: ' + knownEmail + '</i></p>') : '') +
    '<p>In the event you need to check-in again, simply click to reset your session: <button onclick="reProvision()">Revoke Check-in</button></p><hr>';
}
 </script>

<script>
  // These inputs exist only when the check-in form is rendered
  const currentPageEl = document.getElementById('current_page');
  if (currentPageEl) currentPageEl.value = window.location.href;
  var labdefinition = "something";
  const labDefEl = document.getElementById('labdefinition');
  if (labDefEl) labDefEl.value = labdefinition;

let uuid = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
const uidEl = document.getElementById('uid');
if (uidEl) uidEl.value = uuid;
// Initialize the correlation cookie early if not already present
if (!getCookie('fortiuser')) setCookie('fortiuser', uuid, 5);

function reProvision() {
  removeCookie('fortiuser');
  removeCookie('fortiemail');
  removeCookie('forticustomer');
  removeCookie('fortievent');
  try { localStorage.removeItem('forti_profile'); } catch(e) {}
  location.reload();
}

// If a page includes this partial but not the check-in form, still try to prefill any inputs
prefillAnyMatchingInputs(loadProfileFromStorage());

</script>
